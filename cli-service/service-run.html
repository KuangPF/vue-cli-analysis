<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>service.run() | vue-cli-analysis</title>
    <meta name="description" content="vue-cli 源码分析">
    <link rel="icon" href="/vue-cli-analysis/logo.png">
    
    <link rel="preload" href="/vue-cli-analysis/assets/css/0.styles.62c6d76b.css" as="style"><link rel="preload" href="/vue-cli-analysis/assets/js/app.5e6cf502.js" as="script"><link rel="preload" href="/vue-cli-analysis/assets/js/2.e8f5521d.js" as="script"><link rel="preload" href="/vue-cli-analysis/assets/js/17.8ea42e1a.js" as="script"><link rel="prefetch" href="/vue-cli-analysis/assets/js/10.f61e2e4a.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/11.689ebe90.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/12.22a24b02.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/13.a115b9ad.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/14.88a4e34a.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/15.29579823.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/16.901a9713.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/18.49d09b49.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/19.0e67f963.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/20.c3031fad.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/21.21c9314b.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/22.6080236f.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/23.8e6b447a.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/24.d1bdb383.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/25.aa5a4c89.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/26.5d7b6c90.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/27.41b4122c.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/28.fc43defe.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/29.f5d8299e.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/3.dc7226b4.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/30.51b65679.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/31.1004deb2.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/32.5ecf8789.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/33.099a94fb.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/34.cadd8249.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/35.44522568.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/36.1e46fd4c.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/37.6324102c.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/38.902d0c61.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/39.2326e462.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/4.4f698e63.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/40.ed8433bc.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/41.10cac9c1.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/42.eb54bc4f.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/43.a8283c0e.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/44.538870e6.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/45.38a83d43.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/5.dbc517ce.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/6.75b88e83.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/7.18330974.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/8.9c22ca30.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/9.f029ab43.js">
    <link rel="stylesheet" href="/vue-cli-analysis/assets/css/0.styles.62c6d76b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-cli-analysis/" class="home-link router-link-active"><!----> <span class="site-name">vue-cli-analysis</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-cli-analysis/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">cli-service</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>整体介绍</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/entrance.html" class="nav-link">入口</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/new-service.html" class="nav-link">new Service()</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/service-run.html" class="nav-link router-link-exact-active router-link-active">service.run()</a></li></ul></li><li class="dropdown-item"><h4>内置插件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/serve.html" class="nav-link">serve</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/build.html" class="nav-link">build</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/inspect.html" class="nav-link">inspect</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/help.html" class="nav-link">help</a></li></ul></li></ul></div></div> <a href="https://github.com/KuangPF/vue-cli-analysis" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-cli-analysis/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">cli-service</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>整体介绍</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/entrance.html" class="nav-link">入口</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/new-service.html" class="nav-link">new Service()</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/service-run.html" class="nav-link router-link-exact-active router-link-active">service.run()</a></li></ul></li><li class="dropdown-item"><h4>内置插件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/serve.html" class="nav-link">serve</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/build.html" class="nav-link">build</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/inspect.html" class="nav-link">inspect</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/help.html" class="nav-link">help</a></li></ul></li></ul></div></div> <a href="https://github.com/KuangPF/vue-cli-analysis" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/foreword/" class="sidebar-link">介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开始</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/start/env.html" class="sidebar-link">环境介绍</a></li><li><a href="/vue-cli-analysis/start/npm.html" class="sidebar-link">常见 npm 包</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue create</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/create/" class="sidebar-link">create 入口</a></li><li><a href="/vue-cli-analysis/create/overall-analysis.html" class="sidebar-link">整体分析</a></li><li><a href="/vue-cli-analysis/create/basic-verification.html" class="sidebar-link">基础验证</a></li><li><a href="/vue-cli-analysis/create/get-preset.html" class="sidebar-link">获取预设选项（preset）</a></li><li><a href="/vue-cli-analysis/create/install-deps.html" class="sidebar-link">依赖安装（installDeps）</a></li><li><a href="/vue-cli-analysis/create/generator.html" class="sidebar-link">Generator</a></li><li><a href="/vue-cli-analysis/create/end-part.html" class="sidebar-link">结尾分析</a></li><li><a href="/vue-cli-analysis/create/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue add</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/add/" class="sidebar-link">add 入口</a></li><li><a href="/vue-cli-analysis/add/plugin-install.html" class="sidebar-link">安装插件</a></li><li><a href="/vue-cli-analysis/add/plugin-invoke.html" class="sidebar-link">调用插件</a></li><li><a href="/vue-cli-analysis/add/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue invoke</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/invoke/" class="sidebar-link">invoke 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue inspect</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/inspect/" class="sidebar-link">inspect 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue serve</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/serve/" class="sidebar-link">serve 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue build</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/build/" class="sidebar-link">build 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue ui</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/ui/" class="sidebar-link">ui 入口</a></li><li><a href="/vue-cli-analysis/ui/overall-analysis.html" class="sidebar-link">整体分析</a></li><li><a href="/vue-cli-analysis/ui/server.html" class="sidebar-link">server 端</a></li><li><a href="/vue-cli-analysis/ui/client.html" class="sidebar-link">client 端</a></li><li><a href="/vue-cli-analysis/ui/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue init</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/init/" class="sidebar-link">init 入口</a></li><li><a href="/vue-cli-analysis/init/vue-cli-init-module.html" class="sidebar-link">@vue/cli-init 分析</a></li><li><a href="/vue-cli-analysis/init/vue-cli-init-2.x.html" class="sidebar-link">vue-cli 2.x  init 分析</a></li><li><a href="/vue-cli-analysis/init/generate.html" class="sidebar-link">generate 函数分析</a></li><li><a href="/vue-cli-analysis/init/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue config</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/config/" class="sidebar-link">config 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue upgrade</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/upgrade/" class="sidebar-link">upgrade 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue info</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/info/" class="sidebar-link">info 命令</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="service-run"><a href="#service-run" aria-hidden="true" class="header-anchor">#</a> service.run()</h1> <p>还是老规矩，把 <code>run</code> 的源码贴出来看看：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rawArgv <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 命令指定模式</span>
  <span class="token comment">// resolve mode</span>
  <span class="token comment">// prioritize inline --mode</span>
  <span class="token comment">// fallback to resolved default modes from plugins or development if --watch is defined</span>
  <span class="token keyword">const</span> mode <span class="token operator">=</span> args<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'build'</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>watch <span class="token operator">?</span> <span class="token string">'development'</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modes<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// load env variables, load user config, apply plugins</span>
  <span class="token comment">// 加载本地环境变量，vue.config.js || package.vue， 执行所有被加载的插件</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span>
  args<span class="token punctuation">.</span>_ <span class="token operator">=</span> args<span class="token punctuation">.</span>_ <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token comment">// 加载插件时注册了 command，api.registerCommand</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>command <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 非法命令</span>
    <span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">command &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; does not exist.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>command <span class="token operator">||</span> args<span class="token punctuation">.</span>help <span class="token operator">||</span> args<span class="token punctuation">.</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// vue-cli-service || vue-cli-service -h</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ssssss'</span><span class="token punctuation">)</span>
    command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">.</span>help
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    args<span class="token punctuation">.</span>_<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// remove command itself</span>
    rawArgv<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fn <span class="token punctuation">}</span> <span class="token operator">=</span> command
  <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> rawArgv<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p>每次贴代码的时候都会发现，代码不会很长，因为在 vue-cli 3.0 中，很多功能都会被模块化，而且会将一个大的功能拆分成多个小的功能进行实现，这样提高了代码
的可读性并且也利于代码的维护，这种编程方式十分值得学习。</p></div> <p><code>run</code> 方法开始会获取该命令所对应的模式值，然后调用实例的 <code>init</code> 方法，<code>init</code> 主要有三个功能：</p> <ul><li><strong>加载对应模式下本地的环境变量文件</strong></li> <li><strong>解析 vue.config.js 或者 package.vue</strong></li> <li><strong>执行所有被加载的插件</strong></li></ul> <h2 id="loadenv"><a href="#loadenv" aria-hidden="true" class="header-anchor">#</a> loadEnv</h2> <p>那么继续看下 <code>init</code> 方法代码中加载环境变量文件的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// load mode .env</span>
<span class="token comment">// 加载指定的模式环境文件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadEnv</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// load base .env</span>
<span class="token comment">// 加载普通环境文件</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p><code>init</code> 执行了两次实例的 <code>loadEnv</code> 函数，第一次是加载指定的模式环境文件<code>（.env.development, .env.development.local）</code>，第二次执行是加载普通环境文件
<code>(.env, .env.local)</code>，看一下实例 <code>loadEnv</code> 函数代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 加载本地的环境文件，环境文件的作用就是设置某个模式下特有的环境变量</span>
<span class="token comment">// 加载环境变量其实要注意的就是优先级的问题，下面的代码已经体现的非常明显了，先加载 .env.mode.local，然后加载 .env.mode 最后再加载 .env</span>
<span class="token comment">// 由于环境变量不会被覆盖，因此 .env.mode.local 的优先级最高，.env.mode.local 与 .env.mode 的区别就是前者会被 git 忽略掉。另外一点要</span>
<span class="token comment">// 注意的就是环境文件不会覆盖Vue CLI 启动时已经存在的环境变量。</span>
<span class="token function">loadEnv</span> <span class="token punctuation">(</span><span class="token parameter">mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'vue:env'</span><span class="token punctuation">)</span>
  <span class="token comment">// path/.env.production || path/.env.development || ...</span>
  <span class="token keyword">const</span> basePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">.env</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> localPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>basePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.local</span><span class="token template-punctuation string">`</span></span> <span class="token comment">// path/.env.local.production</span>
  <span class="token keyword">const</span> <span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">loadEnv</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
      <span class="token function">logger</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// only ignore error if file is not found</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'ENOENT'</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">load</span><span class="token punctuation">(</span>localPath<span class="token punctuation">)</span>
  <span class="token function">load</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span>
  <span class="token comment">// by default, NODE_ENV and BABEL_ENV are set to &quot;development&quot; unless mode</span>
  <span class="token comment">// is production or test. However the value in .env files will take higher</span>
  <span class="token comment">// priority.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// always set NODE_ENV during tests</span>
    <span class="token comment">// as that is necessary for tests to not be affected by each other</span>
    <span class="token keyword">const</span> shouldForceDefaultEnv <span class="token operator">=</span> <span class="token punctuation">(</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_TEST</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_TEST_TESTING_ENV</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">const</span> defaultNodeEnv <span class="token operator">=</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">||</span> mode <span class="token operator">===</span> <span class="token string">'test'</span><span class="token punctuation">)</span>
      <span class="token operator">?</span> mode
      <span class="token operator">:</span> <span class="token string">'development'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldForceDefaultEnv <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> defaultNodeEnv
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldForceDefaultEnv <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">BABEL_ENV</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">BABEL_ENV</span> <span class="token operator">=</span> defaultNodeEnv
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过代码可以直观的看出来，先加载 <code>localPath</code> ，然后再加载 <code>basePath</code>，load 函数主要执行了 <code>util/loadEnv.js</code> 它的作用就是向 <code>node process</code>
中添加环境变量，核心代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Vue CLI 启动时已经存在的环境变量拥有最高优先级，并不会被 .env 文件覆写</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看着这段源码应该就很容易明白官方文档对环境加载属性的相关提示了：</p> <div class="tip custom-block"><p class="custom-block-title">环境加载属性</p> <p>为一个特定模式准备的环境文件的 (例如 <code>.env.production</code>) 将会比一般的环境文件 (例如 <code>.env</code>) 拥有更高的优先级。</p> <p>此外，Vue CLI 启动时已经存在的环境变量拥有最高优先级，并不会被 <code>.env</code> 文件覆写。</p></div> <h2 id="loaduseroptions"><a href="#loaduseroptions" aria-hidden="true" class="header-anchor">#</a> loadUserOptions</h2> <p>加载完环境变量文件后，接着就是解析项目的配置文件了，项目的配置文件主要存放在两个地方：<code>vue.config.js</code> 和 <code>package.vue</code> 中，当然也可以在
<code>new Service</code> 的时候传入 <code>inlineOptions</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">loadUserOptions</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// vue.config.js</span>
  <span class="token keyword">let</span> fileConfig<span class="token punctuation">,</span> pkgConfig<span class="token punctuation">,</span> resolved<span class="token punctuation">,</span> resolvedFrom
  <span class="token keyword">const</span> configPath <span class="token operator">=</span> <span class="token punctuation">(</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_SERVICE_CONFIG_PATH</span> <span class="token operator">||</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> <span class="token string">'vue.config.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 加载 vue.config.js</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>configPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      fileConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>configPath<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileConfig <span class="token operator">||</span> <span class="token keyword">typeof</span> fileConfig <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">error</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error loading </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token string">'vue.config.js'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: should export an object.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
        fileConfig <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error loading </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token string">'vue.config.js'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// package.vue</span>
  <span class="token comment">// package.json 里面的 vue config</span>
  pkgConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>vue
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgConfig <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> pkgConfig <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error loading vue-cli config in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">package.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">the &quot;vue&quot; field should be an object.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
    pkgConfig <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fileConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 既有 vue.config.js 而且在 package.json 里面又包含了 vue 的配置，将会取 vue.config.js 的配置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;vue&quot; field in package.json ignored </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">due to presence of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token string">'vue.config.js'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You should migrate it into </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token string">'vue.config.js'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">and remove it from package.json.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    resolved <span class="token operator">=</span> fileConfig
    resolvedFrom <span class="token operator">=</span> <span class="token string">'vue.config.js'</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    resolved <span class="token operator">=</span> pkgConfig
    resolvedFrom <span class="token operator">=</span> <span class="token string">'&quot;vue&quot; field in package.json'</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    resolved <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inlineOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    resolvedFrom <span class="token operator">=</span> <span class="token string">'inline options'</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// normalize some options</span>
  <span class="token function">ensureSlash</span><span class="token punctuation">(</span>resolved<span class="token punctuation">,</span> <span class="token string">'baseUrl'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> resolved<span class="token punctuation">.</span>baseUrl <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    resolved<span class="token punctuation">.</span>baseUrl <span class="token operator">=</span> resolved<span class="token punctuation">.</span>baseUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^\.\//</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">removeSlash</span><span class="token punctuation">(</span>resolved<span class="token punctuation">,</span> <span class="token string">'outputDir'</span><span class="token punctuation">)</span>

  <span class="token comment">// deprecation warning</span>
  <span class="token comment">// TODO remove in final release</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">.</span>css <span class="token operator">&amp;&amp;</span> resolved<span class="token punctuation">.</span>css<span class="token punctuation">.</span>localIdentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">css.localIdentName has been deprecated. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">All css-loader options (except &quot;modules&quot;) are now supported via css.loaderOptions.css.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// validate options</span>
  <span class="token function">validate</span><span class="token punctuation">(</span>resolved<span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid options in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span>resolvedFrom<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> resolved
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码写的很清楚了，首先会加载项目中 <code>vue.config.js</code>，然后会加载 <code>package.json</code> 中的 vue 字段中的配置信息。如果既有 <code>vue.config.js</code> 而且在
<code>package.json</code> 里面又包含了 <code>vue</code> 的配置，将会取 <code>vue.config.js</code> 的配置，如果两者都没有配置信息的话会取 <code>this.inlineOptions || {}</code>，
在获取到配置以后还会进行一些处理和验证，最后返回配置 <code>resolved</code> 。</p> <h2 id="apply-plugins"><a href="#apply-plugins" aria-hidden="true" class="header-anchor">#</a> apply plugins</h2> <p>在加载了环境变量文件和项目配置信息后，接下来就开始加载插件了，核心代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> id<span class="token punctuation">,</span> apply <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// service 插件接受两个参数，一个 PluginAPI 实例，一个包含 vue.config.js 内指定的项目本地选项的对象，或者在 package.json 内的 vue 字段。</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PluginAPI</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>其实就是执行 <code>service</code> 函数的导出函数，它接受两个参数，</p> <ul><li>一个 <code>PluginAPI</code> 实例</li> <li>一个包含 <code>vue.config.js</code> 内指定的项目本地选项的对象，或者在 package.json 内的 vue 字段</li></ul> <p>我们主要看下 <code>PluginAPI</code> 类，<code>PluginAPI</code> 核心代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">PluginAPI</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Current working directory.
   */</span>
  <span class="token function">getCwd</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>context
  <span class="token punctuation">}</span>
  <span class="token function">resolve</span> <span class="token punctuation">(</span><span class="token parameter">_path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>context<span class="token punctuation">,</span> _path<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">hasPlugin</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">'router'</span><span class="token punctuation">)</span> id <span class="token operator">=</span> <span class="token string">'vue-router'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'vue-router'</span><span class="token punctuation">,</span> <span class="token string">'vuex'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>pkg
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>dependencies <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>devDependencies <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>devDependencies<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token function">matchesPluginId</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">registerCommand</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> opts <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fn <span class="token operator">=</span> opts
      opts <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>commands<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> fn<span class="token punctuation">,</span> opts<span class="token operator">:</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">chainWebpack</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>webpackChainFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">configureWebpack</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>webpackRawConfigFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">configureDevServer</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>devServerConfigFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">resolveWebpackConfig</span> <span class="token punctuation">(</span><span class="token parameter">chainableConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">resolveWebpackConfig</span><span class="token punctuation">(</span>chainableConfig<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">resolveChainableWebpackConfig</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">resolveChainableWebpackConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">genCacheConfig</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> partialIdentifier<span class="token punctuation">,</span> configFiles</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> cacheDirectory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> variables <span class="token operator">=</span> <span class="token punctuation">{</span>
      partialIdentifier<span class="token punctuation">,</span>
      <span class="token string">'cli-service'</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
      <span class="token string">'cache-loader'</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cache-loader/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
      env<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">,</span>
      test<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_TEST</span><span class="token punctuation">,</span>
      config<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>chainWebpack<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>configureWebpack
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>简单介绍一些 <code>PluginAPI</code> 的方法：</p> <ul><li><strong>registerCommand</strong>: 注册 cli 命令服务</li> <li><strong>chainWebpack</strong>: 通过 webpack-chain 修改 webpack 配置</li> <li><strong>configureWebpack</strong>: 通过 webpack-merge 对 webpack 配置进行合并</li> <li><strong>resolveWebpackConfig</strong>: 调用之前通过 chainWebpack 和 configureWebpack 上完成的对于 webpack 配置的改造，并返回最终的 webpack 配置</li> <li><strong>genCacheConfig</strong>: 返回 <code>cacheDirectory, cacheIdentifier</code></li> <li>...</li></ul> <p>以 <code>@vue/cli-service/lib/commands/serve.js</code> 为例</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">registerCommand</span><span class="token punctuation">(</span><span class="token string">'serve'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    description<span class="token operator">:</span> <span class="token string">'start development server'</span><span class="token punctuation">,</span>
    usage<span class="token operator">:</span> <span class="token string">'vue-cli-service serve [options] [entry]'</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'--open'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">open browser on server start</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string">'--copy'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">copy url to clipboard on server start</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string">'--mode'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">specify env mode (default: development)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string">'--host'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">specify host (default: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>defaults<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string">'--port'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">specify port (default: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>defaults<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string">'--https'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">use https (default: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>defaults<span class="token punctuation">.</span>https<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string">'--public'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">specify the public network URL for the HMR client</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">serve</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// resolveWebpackConfig</span>
   <span class="token comment">// create server</span>
   <span class="token comment">// ....</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>利用 <code>api.registerCommand</code> 注册了 <code>serve</code> 命名，并将 <code>serve</code> 命令的处理函数挂载到 <code>Service</code> 实例的 <code>serve</code> 命令中，当然你还可以通过
<code>module.exports.defaultModes 以 { [commandName]: mode }</code> 的形式来指定命令的运行模式。</p> <p>分析到这里你应该逐渐熟悉 <code>vue-cli 3.0</code> 的插件机制了，<code>vue-cli 3.0</code> 将所有的工作都交给插件去执行，开发模式执行内置 <code>serve</code> 插件，打包执行内置
<code>build</code> 插件，检查代码规范由 <code>@vue/cli-plugin-eslint</code> 插件完成。</p> <p>在加载完所有的插件以后，实例的 <code>init</code> 方法在最后会读取项目配置中的 <code>webpack</code> 配置信息，即 <code>chainWebpack</code> 和 <code>configureWebpack</code>，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// apply webpack configs from project config file</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>chainWebpack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>webpackChainFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>chainWebpack<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>configureWebpack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>webpackRawConfigFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>configureWebpack<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在实例的 run 函数中执行了实例 init 函数对 Service 实例的属性进行初始化，然后就会解析 CLI 命令，看代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
args<span class="token punctuation">.</span>_ <span class="token operator">=</span> args<span class="token punctuation">.</span>_ <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token comment">// 加载插件时注册了 command，api.registerCommand</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>command <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 非法命令</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">command &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; does not exist.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>command <span class="token operator">||</span> args<span class="token punctuation">.</span>help<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// vue-cli-service || vue-cli-service -h</span>
  command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">.</span>help
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  args<span class="token punctuation">.</span>_<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// remove command itself</span>
  rawArgv<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> fn <span class="token punctuation">}</span> <span class="token operator">=</span> command
<span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> rawArgv<span class="token punctuation">)</span>
</code></pre></div><p>会先对 CLI 命令进行一个判断，主要有一下三种情况：</p> <ul><li>输入了命令 <code>name</code> ，但是并没有通过 <code>api.registerCommand</code> 注册，即非法命令，<code>process.exit(1)</code></li> <li>直接输入了 <code>vue-cli-service</code> 或者 <code>vue-cli-service --help</code>，加载内置 <code>help</code> 插件</li> <li>正常输入，eg: <code>vue-cli-service test:unit</code>，这种情况会加载对应地单元测试插件 <code>@vue/cli-plugin-unit-jest</code> ||<code>@vue/cli-plugin-unit-mocha</code></li></ul> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>执行 <code>Service</code> 实例的 <code>run</code> 方法主要执行了环境变量文件加载，获取项目配置信息，合并项目配置，加载插件，加载项目配置中的 webpack 信息，最后
执行 CLI 服务，整个思路还是很清晰，接下来会对 <code>vue-cli-service serve</code> 等命令进行简单地分析介绍。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/KuangPF/vue-cli-analysis/edit/master/docs/cli-service/service-run.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/21/2022, 3:22:31 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vue-cli-analysis/assets/js/app.5e6cf502.js" defer></script><script src="/vue-cli-analysis/assets/js/2.e8f5521d.js" defer></script><script src="/vue-cli-analysis/assets/js/17.8ea42e1a.js" defer></script>
  </body>
</html>
