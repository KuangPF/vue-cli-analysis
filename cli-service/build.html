<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue-cli-service build | vue-cli-analysis</title>
    <meta name="description" content="vue-cli 源码分析">
    <link rel="icon" href="/vue-cli-analysis/logo.png">
    
    <link rel="preload" href="/vue-cli-analysis/assets/css/0.styles.62c6d76b.css" as="style"><link rel="preload" href="/vue-cli-analysis/assets/js/app.5e6cf502.js" as="script"><link rel="preload" href="/vue-cli-analysis/assets/js/2.e8f5521d.js" as="script"><link rel="preload" href="/vue-cli-analysis/assets/js/11.689ebe90.js" as="script"><link rel="prefetch" href="/vue-cli-analysis/assets/js/10.f61e2e4a.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/12.22a24b02.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/13.a115b9ad.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/14.88a4e34a.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/15.29579823.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/16.901a9713.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/17.8ea42e1a.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/18.49d09b49.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/19.0e67f963.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/20.c3031fad.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/21.21c9314b.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/22.6080236f.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/23.8e6b447a.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/24.d1bdb383.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/25.aa5a4c89.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/26.5d7b6c90.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/27.41b4122c.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/28.fc43defe.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/29.f5d8299e.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/3.dc7226b4.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/30.51b65679.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/31.1004deb2.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/32.5ecf8789.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/33.099a94fb.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/34.cadd8249.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/35.44522568.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/36.1e46fd4c.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/37.6324102c.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/38.902d0c61.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/39.2326e462.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/4.4f698e63.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/40.ed8433bc.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/41.10cac9c1.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/42.eb54bc4f.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/43.a8283c0e.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/44.538870e6.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/45.38a83d43.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/5.dbc517ce.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/6.75b88e83.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/7.18330974.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/8.9c22ca30.js"><link rel="prefetch" href="/vue-cli-analysis/assets/js/9.f029ab43.js">
    <link rel="stylesheet" href="/vue-cli-analysis/assets/css/0.styles.62c6d76b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-cli-analysis/" class="home-link router-link-active"><!----> <span class="site-name">vue-cli-analysis</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-cli-analysis/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">cli-service</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>整体介绍</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/entrance.html" class="nav-link">入口</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/new-service.html" class="nav-link">new Service()</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/service-run.html" class="nav-link">service.run()</a></li></ul></li><li class="dropdown-item"><h4>内置插件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/serve.html" class="nav-link">serve</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/build.html" class="nav-link router-link-exact-active router-link-active">build</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/inspect.html" class="nav-link">inspect</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/help.html" class="nav-link">help</a></li></ul></li></ul></div></div> <a href="https://github.com/KuangPF/vue-cli-analysis" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-cli-analysis/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">cli-service</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>整体介绍</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/entrance.html" class="nav-link">入口</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/new-service.html" class="nav-link">new Service()</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/service-run.html" class="nav-link">service.run()</a></li></ul></li><li class="dropdown-item"><h4>内置插件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/serve.html" class="nav-link">serve</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/build.html" class="nav-link router-link-exact-active router-link-active">build</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/inspect.html" class="nav-link">inspect</a></li><li class="dropdown-subitem"><a href="/vue-cli-analysis/cli-service/help.html" class="nav-link">help</a></li></ul></li></ul></div></div> <a href="https://github.com/KuangPF/vue-cli-analysis" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/foreword/" class="sidebar-link">介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开始</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/start/env.html" class="sidebar-link">环境介绍</a></li><li><a href="/vue-cli-analysis/start/npm.html" class="sidebar-link">常见 npm 包</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue create</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/create/" class="sidebar-link">create 入口</a></li><li><a href="/vue-cli-analysis/create/overall-analysis.html" class="sidebar-link">整体分析</a></li><li><a href="/vue-cli-analysis/create/basic-verification.html" class="sidebar-link">基础验证</a></li><li><a href="/vue-cli-analysis/create/get-preset.html" class="sidebar-link">获取预设选项（preset）</a></li><li><a href="/vue-cli-analysis/create/install-deps.html" class="sidebar-link">依赖安装（installDeps）</a></li><li><a href="/vue-cli-analysis/create/generator.html" class="sidebar-link">Generator</a></li><li><a href="/vue-cli-analysis/create/end-part.html" class="sidebar-link">结尾分析</a></li><li><a href="/vue-cli-analysis/create/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue add</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/add/" class="sidebar-link">add 入口</a></li><li><a href="/vue-cli-analysis/add/plugin-install.html" class="sidebar-link">安装插件</a></li><li><a href="/vue-cli-analysis/add/plugin-invoke.html" class="sidebar-link">调用插件</a></li><li><a href="/vue-cli-analysis/add/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue invoke</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/invoke/" class="sidebar-link">invoke 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue inspect</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/inspect/" class="sidebar-link">inspect 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue serve</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/serve/" class="sidebar-link">serve 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue build</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/build/" class="sidebar-link">build 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue ui</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/ui/" class="sidebar-link">ui 入口</a></li><li><a href="/vue-cli-analysis/ui/overall-analysis.html" class="sidebar-link">整体分析</a></li><li><a href="/vue-cli-analysis/ui/server.html" class="sidebar-link">server 端</a></li><li><a href="/vue-cli-analysis/ui/client.html" class="sidebar-link">client 端</a></li><li><a href="/vue-cli-analysis/ui/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue init</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/init/" class="sidebar-link">init 入口</a></li><li><a href="/vue-cli-analysis/init/vue-cli-init-module.html" class="sidebar-link">@vue/cli-init 分析</a></li><li><a href="/vue-cli-analysis/init/vue-cli-init-2.x.html" class="sidebar-link">vue-cli 2.x  init 分析</a></li><li><a href="/vue-cli-analysis/init/generate.html" class="sidebar-link">generate 函数分析</a></li><li><a href="/vue-cli-analysis/init/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue config</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/config/" class="sidebar-link">config 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue upgrade</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/upgrade/" class="sidebar-link">upgrade 命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue info</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-cli-analysis/info/" class="sidebar-link">info 命令</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-cli-service-build"><a href="#vue-cli-service-build" aria-hidden="true" class="header-anchor">#</a> vue-cli-service build</h1> <p><code>vue-cli-service build</code> 会在 <code>dist/</code> 目录产生一个可用于生产环境的包，带有 JS/CSS/HTML 的压缩，和为更好的缓存而做的自动的 vendor chunk splitting。
它的 chunk manifest 会内联在 HTML 里。</p> <p>相比 vue-cli 2.x 版本而言，vue-cli 3.0 在构建生产环境包的时候拥有更多的选择，执行 <code>vue-cli-service build --help</code> 可查看参数：</p> <div class="language- extra-class"><pre class="language-text"><code>--mode              指定环境模式 (默认值：production)
--dest              指定输出目录 (默认值：dist)
--modern            面向现代浏览器带自动回退地构建应用
--no-unsafe-inline  不以 inline 方式引入 script （针对 Safari 10 中 &lt;script nomodule&gt; 的修复）
--target            app | lib | wc | wc-async (默认值：app)
--formats           构建目标为库的时候指定输出格式默认为 commonjs,umd,umd-min
--name              库或 Web Components 模式下的名字 (默认值：package.json 中的 &quot;name&quot; 字段或入口文件名)
--no-clean          在构建项目之前不清除目标目录
--report            生成 report.html 以帮助分析包内容
--report-json       生成 report.json 以帮助分析包内容
--watch             监听文件变化
</code></pre></div><p>其中<a href="https://cli.vuejs.org/zh/guide/build-targets.html" target="_blank" rel="noopener noreferrer">构建目标<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://cli.vuejs.org/zh/guide/browser-compatibility.html#%E7%8E%B0%E4%BB%A3%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">现代模式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
很有意思，官方文档对这两个参数做了详细的介绍，这里就先不重复描述了。<code>build</code> 命令的运行流程和 <code>serve</code> 命令类似，都会先获取 webpack 的配置，然后进行 webpack 构建，下面就简单看下源码。</p> <p>执行 build 命令最终执行的是 build 对应的服务，源码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> defaults<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      args<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> defaults<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  args<span class="token punctuation">.</span>entry <span class="token operator">=</span> args<span class="token punctuation">.</span>entry <span class="token operator">||</span> args<span class="token punctuation">.</span>_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 构建一个库的入口文件，默认为 src/App.vue</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>target <span class="token operator">!==</span> <span class="token string">'app'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    args<span class="token punctuation">.</span>entry <span class="token operator">=</span> args<span class="token punctuation">.</span>entry <span class="token operator">||</span> <span class="token string">'src/App.vue'</span>
  <span class="token punctuation">}</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_BUILD_TARGET</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>target
  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>modern <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">'app'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 现代模式</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_MODERN_MODE</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">delete</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_MODERN_BUILD</span>
    <span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// 支持旧浏览器</span>
      modernBuild<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      keepAlive<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> api<span class="token punctuation">,</span> options<span class="token punctuation">)</span>

    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_MODERN_BUILD</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// 支持现代浏览器</span>
      modernBuild<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      clean<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> api<span class="token punctuation">,</span> options<span class="token punctuation">)</span>

    <span class="token keyword">delete</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_MODERN_MODE</span>
    <span class="token keyword">delete</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_MODERN_BUILD</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>modern<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> warn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/cli-shared-utils'</span><span class="token punctuation">)</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Modern mode only works with default target (app). </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">For libraries or web components, use the browserslist </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">config to specify target browsers.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> api<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">delete</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_BUILD_TARGET</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码应该比较好理解，主要是对构建目标为 <code>app</code> 并且使用了<code>modern</code> 参数的情形做了一些处理，然后调用了 <code>build</code> 函数。另外还需注意的一点就是在这里对一些环境变量进行了赋值，比如：
<code>VUE_CLI_BUILD_TARGET</code>,<code>VUE_CLI_MODERN_MODE</code>,<code>VUE_CLI_MODERN_BUILD</code>，这些在使用内置配置插件进行解析 webpack 配置时很有用。接着看 build 函数，
主要代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">'app'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 构建目标 app</span>
  <span class="token keyword">const</span> bundleTag <span class="token operator">=</span> args<span class="token punctuation">.</span>modern <span class="token comment">// 现代版本还是旧浏览器版本</span>
    <span class="token operator">?</span> args<span class="token punctuation">.</span>modernBuild
      <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">modern bundle </span><span class="token template-punctuation string">`</span></span>
      <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">legacy bundle </span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
  <span class="token function">logWithSpinner</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Building </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bundleTag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 获取构建目标 lib || wc || wc-async</span>
  <span class="token keyword">const</span> buildMode <span class="token operator">=</span> buildModes<span class="token punctuation">[</span>args<span class="token punctuation">.</span>target<span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>buildMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不同的构建版本 myLib.common.js，myLib.umd.js，myLib.umd.min.js</span>
    <span class="token keyword">const</span> additionalParams <span class="token operator">=</span> buildMode <span class="token operator">===</span> <span class="token string">'library'</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>formats<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
    <span class="token function">logWithSpinner</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Building for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> as </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildMode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>additionalParams<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unknown build target: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// some code ...</span>
<span class="token comment">// resolve raw webpack config</span>
<span class="token keyword">let</span> webpackConfig
<span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">'lib'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 加载构建目标为 lib 的 webpack 配置</span>
  webpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./resolveLibConfig'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> args<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token comment">// 加载构建目标为 wc || wc-async 的 webpack 配置</span>
  args<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">'wc'</span> <span class="token operator">||</span>
  args<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">'wc-async'</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  webpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./resolveWcConfig'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> args<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 默认的应用构建目标</span>
  webpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./resolveAppConfig'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> args<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// check for common config errors</span>
<span class="token function">validateWebpackConfig</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> api<span class="token punctuation">,</span> options<span class="token punctuation">,</span> args<span class="token punctuation">.</span>target<span class="token punctuation">)</span>

<span class="token comment">// some code ...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>dest<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 指定输出目录 (默认值：dist)，args.dest 有更高的优先级</span>
  <span class="token function">modifyConfig</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path <span class="token operator">=</span> targetDir
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// some code ...</span>

<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">webpack</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// some code ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>归纳一下，大致可以分为以下4个部分来分析：</p> <ul><li>build 信息处理</li> <li>解析 webpack 配置</li> <li>打包参数处理</li> <li>webpack 打包</li></ul> <h2 id="build-信息处理"><a href="#build-信息处理" aria-hidden="true" class="header-anchor">#</a> build 信息处理</h2> <p>这一部分其实没什么说的，主要就是将一些 build 的信息通过 <a href="https://github.com/sindresorhus/ora" target="_blank" rel="noopener noreferrer">ora<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 配置 <a href="https://github.com/chalk/chalk" target="_blank" rel="noopener noreferrer">chalk<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
文字显示，如下图：</p> <img src="/vue-cli-analysis/assets/vue-cli-service-build-img01.gif"> <img src="/vue-cli-analysis/assets/vue-cli-service-build-img02.gif"> <h2 id="解析-webpack-配置"><a href="#解析-webpack-配置" aria-hidden="true" class="header-anchor">#</a> 解析 webpack 配置</h2> <p>解析 webpack 配置是 build 命令比较核心的部分了，相比 serve 命令来说，build 除了调用实例 <code>resolveWebpackConfig</code> 获取 webpack 配置外，还会
根据构建目标 target 的不同修改 webpack 配置，其中内置的 <code>config/prod.js</code> 和 <code>config/app.js</code> 根据不同的环境变量进行 webpack 配置的注入，前者
通过 <code>process.env.NODE_ENV === 'production'</code> 判断，后者通过 <code>process.env.VUE_CLI_BUILD_TARGET</code> 判断。
下面以构建目标为 lib 为例，简单分析下是如何解析 webpack 配置的，解析 webpack 配置的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">'lib'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 加载构建目标为 lib 的 webpack 配置</span>
  webpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./resolveLibConfig'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> args<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>然后继续看下 <code>resolveLibConfig</code> 文件:</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> <span class="token punctuation">{</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> formats <span class="token punctuation">}</span><span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> log<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/cli-shared-utils'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">abort</span> <span class="token operator">=</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">const</span> fullEntryPath <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>fullEntryPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">abort</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to resolve lib entry: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entry<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entry <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/App.vue</span><span class="token template-punctuation string">`</span></span> <span class="token operator">?</span> <span class="token string">' (default)'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Make sure to specify the correct entry file.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">const</span> isVueEntry <span class="token operator">=</span> <span class="token regex">/\.vue$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
  <span class="token keyword">const</span> libName <span class="token operator">=</span> <span class="token punctuation">(</span>
    name <span class="token operator">||</span>
    api<span class="token punctuation">.</span>service<span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>name <span class="token operator">||</span>
    path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\.(jsx?|vue)$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  
  <span class="token keyword">function</span> <span class="token function">genConfig</span> <span class="token punctuation">(</span><span class="token parameter">format<span class="token punctuation">,</span> postfix <span class="token operator">=</span> format<span class="token punctuation">,</span> genHTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// some code ...</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">const</span> configMap <span class="token operator">=</span> <span class="token punctuation">{</span>
    commonjs<span class="token operator">:</span> <span class="token function">genConfig</span><span class="token punctuation">(</span><span class="token string">'commonjs2'</span><span class="token punctuation">,</span> <span class="token string">'common'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    umd<span class="token operator">:</span> <span class="token function">genConfig</span><span class="token punctuation">(</span><span class="token string">'umd'</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'umd-min'</span><span class="token operator">:</span> <span class="token function">genConfig</span><span class="token punctuation">(</span><span class="token string">'umd'</span><span class="token punctuation">,</span> <span class="token string">'umd.min'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">const</span> formatArray <span class="token operator">=</span> <span class="token punctuation">(</span>formats <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> configs <span class="token operator">=</span> formatArray<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">format</span> <span class="token operator">=&gt;</span> configMap<span class="token punctuation">[</span>format<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>configs<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> unknownFormats <span class="token operator">=</span> formatArray<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">f</span> <span class="token operator">=&gt;</span> configMap<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span>
    <span class="token function">abort</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unknown library build formats: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unknownFormats<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> configs
<span class="token punctuation">}</span>
</code></pre></div><p>从代码中可以看出，会先获取入口文件地址，并判断是否存在，然后获取 lib 的名称，然后接下来就是调用核心方法 <code>genConfig</code> 返回 webpack 配置。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genConfig</span> <span class="token punctuation">(</span><span class="token parameter">format<span class="token punctuation">,</span> postfix <span class="token operator">=</span> format<span class="token punctuation">,</span> genHTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">resolveChainableWebpackConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// adjust css output name so they write to the same file</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'extract-css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config
      <span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'extract-css'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">args</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>libName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.css</span><span class="token template-punctuation string">`</span></span>
          <span class="token keyword">return</span> args
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// only minify min entry</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/\.min/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>postfix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span><span class="token function">minimize</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// externalize Vue in case user imports it</span>
  config
    <span class="token punctuation">.</span><span class="token function">externals</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>config<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'externals'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      vue<span class="token operator">:</span> <span class="token punctuation">{</span>
        commonjs<span class="token operator">:</span> <span class="token string">'vue'</span><span class="token punctuation">,</span>
        commonjs2<span class="token operator">:</span> <span class="token string">'vue'</span><span class="token punctuation">,</span>
        root<span class="token operator">:</span> <span class="token string">'Vue'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// inject demo page for umd</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>genHTML<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> template <span class="token operator">=</span> isVueEntry <span class="token operator">?</span> <span class="token string">'demo-lib.html'</span> <span class="token operator">:</span> <span class="token string">'demo-lib-js.html'</span>
    config
      <span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'demo-html'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
          template<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">,</span>
          inject<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          filename<span class="token operator">:</span> <span class="token string">'demo.html'</span><span class="token punctuation">,</span>
          libName
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// resolve entry/output</span>
  <span class="token keyword">const</span> entryName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>libName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>postfix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  config<span class="token punctuation">.</span>resolve
    <span class="token punctuation">.</span>alias
      <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'~entry'</span><span class="token punctuation">,</span> fullEntryPath<span class="token punctuation">)</span>

  <span class="token comment">// set output target before user configureWebpack hooks are applied</span>
  config<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">libraryTarget</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span>

  <span class="token comment">// set entry/output after user configureWebpack hooks are applied</span>
  <span class="token keyword">const</span> rawConfig <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">resolveWebpackConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>

  <span class="token keyword">let</span> realEntry <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./entry-lib.js'</span><span class="token punctuation">)</span>

  <span class="token comment">// avoid importing default if user entry file does not have default export</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isVueEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entryContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>fullEntryPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/\b(export\s+default|export\s{[^}]+as\s+default)\b/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>entryContent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      realEntry <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./entry-lib-no-default.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  rawConfig<span class="token punctuation">.</span>entry <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>entryName<span class="token punctuation">]</span><span class="token operator">:</span> realEntry
  <span class="token punctuation">}</span>

  rawConfig<span class="token punctuation">.</span>output <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token comment">// some code ...</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> rawConfig
<span class="token punctuation">}</span>
</code></pre></div><p><code>genConfig</code> 函数先是通过 <code>api.resolveChainableWebpackConfig</code> 获取了 <code>webpack-chain</code> 形式的 webpack 配置，然后进行以下修改：</p> <ul><li>修改输出 css 的名称</li> <li>针对于 umd-min 形式进行压缩</li> <li>对 Vue 进行外部扩展，<a href="https://webpack.docschina.org/configuration/externals/" target="_blank" rel="noopener noreferrer">webpack 外部扩展<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>在此之后就调用 <code>api.resolveWebpackConfig</code> 将 <code>webpack-chain</code> 形式的配置与 <code>raw</code> 式的配置进行合并，并对 output 选项进行一些修改，返回最终的
webpack 配置。</p> <p>有点需要注意的就是这里返回的 configs 为一个数组，因为当构建目标为 lib 时默认会输出 common.js，umd.js，umd.min.js 三种形式的包，因此
传入一个数组的 webpack 配置就会分别执行三次不同的构建，当然也可以通过 <code>--formats</code> 参数来指定输出哪些格式的包，比如执行下面命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vue-cli-service build --target lib --formats commonjs,umd
</code></pre></div><p>此时就只会输出 common.js 和 umd.js 。</p> <h2 id="打包参数处理"><a href="#打包参数处理" aria-hidden="true" class="header-anchor">#</a> 打包参数处理</h2> <p>打包参数处理比较容易，根据 args 来进行对应的配置，比如根据参数 <code>dest</code> 来配置输出目录，参数 <code>watch</code> 判断是否需要监听文件变化，参数 <code>report</code>
判断是否需要生成包的分析内容等等。</p> <h2 id="webpack-打包"><a href="#webpack-打包" aria-hidden="true" class="header-anchor">#</a> webpack 打包</h2> <p>这部分就是传入 webpack 配置进行构建，并输出一些打包信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">webpack</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">stopSpinner</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Build failed with errors.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">.</span>silent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> targetDirShort <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>
        api<span class="token punctuation">.</span>service<span class="token punctuation">.</span>context<span class="token punctuation">,</span>
        targetDir
      <span class="token punctuation">)</span>
      <span class="token function">log</span><span class="token punctuation">(</span><span class="token function">formatStats</span><span class="token punctuation">(</span>stats<span class="token punctuation">,</span> targetDirShort<span class="token punctuation">,</span> api<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">'app'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isLegacyBuild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">.</span>watch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">done</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Build complete. The </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>targetDirShort<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> directory is ready to be deployed.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Check out deployment instructions at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://cli.vuejs.org/guide/deployment.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">done</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Build complete. Watching for changes...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// test-only signal</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_TEST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Build complete.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>vue-cli-service build</code> 命令的分析就到这里了，通过对 <code>serve</code> 和 <code>build</code> 命令简单分析，应该整体上对 <code>vue-cli-service</code> 有了一定的感受，与
<code>vue-cli 2.x</code> 相比，<code>vue-cli 3.0</code> 的 webpack 配置都由<code>@vue/cli-service</code> 收敛到了内部完成。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/KuangPF/vue-cli-analysis/edit/master/docs/cli-service/build.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/21/2022, 3:22:31 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vue-cli-analysis/assets/js/app.5e6cf502.js" defer></script><script src="/vue-cli-analysis/assets/js/2.e8f5521d.js" defer></script><script src="/vue-cli-analysis/assets/js/11.689ebe90.js" defer></script>
  </body>
</html>
